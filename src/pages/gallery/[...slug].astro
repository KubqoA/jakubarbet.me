---
import {getCollection} from 'astro:content'
import {Image} from 'astro:assets'
import BaseLayout from '~/layouts/BaseLayout.astro'
import Prose from '~/components/Prose.astro'
import {getAlbumImages} from '~/utils/albums'

export async function getStaticPaths() {
  const galleryEntries = await getCollection('albums')
  return galleryEntries.map((gallery) => ({
    params: {slug: gallery.slug},
    props: {gallery},
  }))
}

const {gallery} = Astro.props
const {Content} = await gallery.render()
const images = await getAlbumImages(gallery.slug)
---

<BaseLayout title={gallery.data.name} back="/photography" fullWidth>
  <h2 class="mb-4 font-sans text-xl text-gray-950 md:text-2xl">{gallery.data.name}</h2>
  <Prose class="-mt-2 mb-4 max-w-prose text-lg text-gray-800 md:text-xl"><Content /></Prose>

  <div
    class="grid grid-flow-row-dense grid-cols-1 items-center gap-y-4 md:grid-cols-2 md:gap-4 lg:grid-cols-3 xl:grid-cols-4"
    data-gallery
  >
    {
      images.map((image) => (
        <a
          href={image.src}
          data-pswp-width={image.width}
          data-pswp-height={image.height}
          class={`relative block h-min overflow-hidden rounded-md ${image.horizontal ? 'md:col-span-2' : ''}`}
        >
          <div
            aria-hidden="true"
            style={image.placeholder}
            class="absolute inset-0 z-[-1] h-full w-full scale-150 transform blur-2xl filter"
          />
          <Image
            src={image}
            alt={`Image from ${gallery.data.name} album`}
            format="avif"
            quality={80}
            breakpoints={[image.horizontal ? 1200 : 600]}
            width={image.horizontal ? 2000 : 1000}
            class="w-full"
          />
        </a>
      ))
    }
  </div>
</BaseLayout>

<script>
  import PhotoSwipeLightbox from 'photoswipe/lightbox'
  import 'photoswipe/style.css'

  const lightbox = new PhotoSwipeLightbox({
    gallery: '[data-gallery]',
    children: 'a',
    pswpModule: () => import('photoswipe'),
  })
  lightbox.init()
</script>
